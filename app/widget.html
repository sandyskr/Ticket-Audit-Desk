<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="style.css">
    <style>
        .hidden {
            display: none;
        }

        #message-container {
            padding: 20px;
            text-align: center;
            font-family: sans-serif;
            color: #555;
        }

        /* Added a class to wrap fields for easier toggling */
        .reason-wrapper {
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <div id="message-container" class="hidden">
        <h3>Ticket Audit is only available for Closed tickets.</h3>
    </div>

    <div id="main-widget-content" class="hidden">
        <div class="widget-container">
            
            <div class="audit-form">
                <div class="field-block">
                    <label>Priority <span class="info-icon"></span></label>
                    <select id="priority-dropdown">
                        <option value="">-- Select Priority --</option>
                        <option value="Not Answered">Not Answered</option>
                        <option value="Correct">Correct</option>
                        <option value="Incorrect">Incorrect</option>
                    </select>
                    
                    <div id="priority-reason-wrapper" class="reason-wrapper hidden">
                        <label class="sub-label">Correct Priority Reason</label>
                        <textarea id="priority-reason" placeholder="Enter reason..."></textarea>
                    </div>
                </div>

                <hr class="separator">

                <div class="field-block">
                    <label>Resolution Code <span class="info-icon"></span></label>
                    <select id="res-code-dropdown">
                        <option value="">-- Select Code --</option>
                        <option value="Not Answered">Not Answered</option>
                        <option value="Correct">Correct</option>
                        <option value="Incorrect">Incorrect</option>
                    </select>
                    
                    <div id="res-reason-wrapper" class="reason-wrapper hidden">
                        <label class="sub-label">Correct Resolution Code Reason</label>
                        <textarea id="res-reason" placeholder="Enter reason..."></textarea>
                    </div>
                </div>

                <hr class="separator">

                <div class="field-block">
                    <label>Contact Information <span class="info-icon"></span></label>
                    <select id="contact-info-dropdown">
                        <option value="">-- Select Status --</option>
                        <option value="Not Complete">Not Complete</option>
                        <option value="Correct">Correct</option>
                        <option value="Incorrect">Incorrect</option>
                    </select>
                    
                    <div id="contact-info-reason-wrapper" class="reason-wrapper hidden">
                        <label class="sub-label">Correct Contact Information <span class="info-icon">â“˜</span></label>
                        <textarea id="contact-info-reason" placeholder="Enter details..."></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer-actions">
            <button id="submit-audit" class="submit-btn">Submit Audit</button>
            <p id="status-msg"></p>
        </div>
    </div>

    <script src="https://js.zohostatic.com/support/developer_sdk/v1/js/ZohoDeskClientSDK.min.js"></script>
<script>
    let currentTicket = {};
    let currentUser = {};

    // Helper to handle conditional visibility
    function toggleReasonField(dropdownId, wrapperId, triggerValues) {
        const dropdown = document.getElementById(dropdownId);
        const wrapper = document.getElementById(wrapperId);
        const textarea = wrapper.querySelector('textarea');

        if (triggerValues.includes(dropdown.value)) {
            wrapper.classList.remove('hidden');
        } else {
            wrapper.classList.add('hidden');
            textarea.value = ""; // Clear value if hidden
            textarea.classList.remove('error-border');
        }
    }

    window.onload = function () {
        console.clear();
        console.log("Audit Widget: Window Loaded. Initializing SDK...");

        ZOHODESK.extension.onload().then(function (App) {
            console.log("Audit Widget: SDK Handshake Successful.", App);

            // 1. Fetch User Info
            ZOHODESK.get('user').then(function (userData) {
                console.log("Audit Widget: Raw User Data Received:", userData);
                if (userData && userData.user) {
                    currentUser = userData.user;
                    console.log("Audit Widget: User context set:", currentUser.name, "(ID:", currentUser.id + ")");
                } else {
                    console.warn("Audit Widget: User data structure unexpected.");
                }
            }).catch(function (err) {
                console.error("Audit Widget: Error fetching user info:", err);
            });

            // 2. Fetch Ticket Info
            ZOHODESK.get('ticket').then(function (res) {
                console.log("Audit Widget: Raw Ticket Response:", res);

                if (res.status === 'success') {
                    currentTicket = res.ticket;
                    console.log("Audit Widget: Ticket Context Loaded. Status:", currentTicket.status, "ID:", currentTicket.id);

                    const mainContent = document.getElementById('main-widget-content');
                    const msgContainer = document.getElementById('message-container');

                    if (currentTicket.status === 'Closed') {
                        console.log("Audit Widget: Ticket is Closed. Displaying form.");
                        mainContent.classList.remove('hidden');
                        msgContainer.classList.add('hidden');
                    } else {
                        console.log("Audit Widget: Ticket is NOT Closed. Showing restriction message.");
                        mainContent.classList.add('hidden');
                        msgContainer.classList.remove('hidden');
                    }
                } else {
                    console.error("Audit Widget: Ticket fetch failed with status:", res.status);
                }
            }).catch(function(err) {
                console.error("Audit Widget: Exception during ZOHODESK.get('ticket'):", err);
            });

            // Add Event Listeners for Dynamic UI
            document.getElementById('priority-dropdown').addEventListener('change', function() {
                toggleReasonField('priority-dropdown', 'priority-reason-wrapper', ['Incorrect']);
            });
            document.getElementById('res-code-dropdown').addEventListener('change', function() {
                toggleReasonField('res-code-dropdown', 'res-reason-wrapper', ['Incorrect']);
            });
            document.getElementById('contact-info-dropdown').addEventListener('change', function() {
                toggleReasonField('contact-info-dropdown', 'contact-info-reason-wrapper', ['Incorrect', 'Not Complete']);
            });

            // 3. Handle Form Submission
            document.getElementById('submit-audit').onclick = function () {
                console.log("Audit Widget: Submit Button Clicked.");
                const statusMsg = document.getElementById('status-msg');
                
                // Define logic for which fields are mandatory based on visibility
                const fieldsToValidate = [
                    'priority-dropdown',
                    'res-code-dropdown',
                    'contact-info-dropdown'
                ];

                // Only add reason fields to validation if their wrapper is visible
                if (!document.getElementById('priority-reason-wrapper').classList.contains('hidden')) fieldsToValidate.push('priority-reason');
                if (!document.getElementById('res-reason-wrapper').classList.contains('hidden')) fieldsToValidate.push('res-reason');
                if (!document.getElementById('contact-info-reason-wrapper').classList.contains('hidden')) fieldsToValidate.push('contact-info-reason');

                let isFormValid = true;
                let firstErrorField = null;

                // Validate only the relevant fields
                fieldsToValidate.forEach(id => {
                    const el = document.getElementById(id);
                    if (!el.value.trim()) {
                        el.classList.add('error-border', 'shake');
                        isFormValid = false;
                        if (!firstErrorField) firstErrorField = el;
                        setTimeout(() => el.classList.remove('shake'), 400);
                    } else {
                        el.classList.remove('error-border');
                    }
                });

                if (!isFormValid) {
                    console.warn("Audit Widget: Form validation failed.");
                    statusMsg.innerText = "All visible fields are mandatory.";
                    statusMsg.style.color = "#e53935";
                    if(firstErrorField) firstErrorField.focus();
                    return;
                }

                const auditData = {
                    "name": currentTicket.subject || "No Subject",
                    "department": currentTicket.departmentId,
                    "owner": currentUser.id,
                    "cf": {
                        "cf_ticket_number_1": currentTicket.number,
                        "cf_ticket_number": currentTicket.id.toString(),
                        "cf_priority": document.getElementById('priority-dropdown').value,
                        "cf_correct_priority_reason": document.getElementById('priority-reason').value,
                        "cf_resolution_code": document.getElementById('res-code-dropdown').value,
                        "cf_correct_resolution_code_reason": document.getElementById('res-reason').value,
                        "cf_contact_information": document.getElementById('contact-info-dropdown').value,
                        "cf_correct_contact_information": document.getElementById('contact-info-reason').value
                    }
                };

                console.log("Audit Widget: Preparing to POST. Payload:", JSON.stringify(auditData));

                statusMsg.innerText = "Submitting...";
                statusMsg.style.color = "#666";

                ZOHODESK.request({
                    url: 'https://desk.zoho.com/api/v1/cm_ticket_audits',
                    type: 'POST',
                    postBody: auditData,
                    headers: { "orgId": "850352696", "featureFlags": "lookUp" },
                    connectionLinkName: "zdesk"
                }).then(function (submitRes) {
                    console.log("Audit Widget: API Success Response:", submitRes);
                    statusMsg.innerText = "Audit Submitted Successfully!";
                    statusMsg.style.color = "green";
                    
                    // Reset all fields and hide reasons
                    const allFields = ['priority-dropdown', 'priority-reason', 'res-code-dropdown', 'res-reason', 'contact-info-dropdown', 'contact-info-reason'];
                    allFields.forEach(id => {
                        document.getElementById(id).value = "";
                        document.getElementById(id).classList.remove('error-border');
                    });
                    document.getElementById('priority-reason-wrapper').classList.add('hidden');
                    document.getElementById('res-reason-wrapper').classList.add('hidden');
                    document.getElementById('contact-info-reason-wrapper').classList.add('hidden');

                }).catch(function (error) {
                    console.error("Audit Widget: API Submission Error Details:", error);
                    statusMsg.innerText = "Submission Error. Check console.";
                    statusMsg.style.color = "red";
                });
            };

            document.querySelectorAll('select, textarea').forEach(el => {
                el.addEventListener('input', () => el.classList.remove('error-border'));
            });

        }).catch(function(err) {
            console.error("Audit Widget: SDK Initialization Failed!", err);
        });
    };
</script>
</body>

</html>